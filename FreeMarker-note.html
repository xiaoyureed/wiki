<!DOCTYPE HTML>
<html lang="en" class="sidebar-visible no-js light">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>FreeMarker-note - Xiaoyu Wiki</title>
        

        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff" />

        <link rel="shortcut icon" href="favicon.png">
        <link rel="stylesheet" href="css/variables.css">
        <link rel="stylesheet" href="css/general.css">
        <link rel="stylesheet" href="css/chrome.css">
        <link rel="stylesheet" href="css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="FontAwesome/css/font-awesome.css">
        <link href="https://fonts.googleapis.com/css?family=Open+Sans:300italic,400italic,600italic,700italic,800italic,400,300,600,700,800" rel="stylesheet" type="text/css">
        <link href="https://fonts.googleapis.com/css?family=Source+Code+Pro:500" rel="stylesheet" type="text/css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="highlight.css">
        <link rel="stylesheet" href="tomorrow-night.css">
        <link rel="stylesheet" href="ayu-highlight.css">

        <!-- Custom theme stylesheets -->
        

        
    </head>
    <body>
        <!-- Provide site root to javascript -->
        <script type="text/javascript">
            var path_to_root = "";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "light" : "light";
        </script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script type="text/javascript">
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script type="text/javascript">
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            var html = document.querySelector('html');
            html.classList.remove('no-js')
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add('js');
        </script>

        <!-- Hide / unhide sidebar before it is displayed -->
        <script type="text/javascript">
            var html = document.querySelector('html');
            var sidebar = 'hidden';
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            }
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <div class="sidebar-scrollbox">
                <ol class="chapter"><li class="chapter-item expanded affix "><a href="pre.html">pre page</a></li><li class="chapter-item expanded "><a href="SpringBoot-note.html"><strong aria-hidden="true">1.</strong> Spring boot note</a></li><li class="chapter-item expanded "><a href="springcloud-note.html"><strong aria-hidden="true">2.</strong> springcloud-note</a></li><li class="chapter-item expanded "><a href="java-concurrent.html"><strong aria-hidden="true">3.</strong> java-concurrent</a></li><li class="chapter-item expanded "><a href="java-memory-model-jmm-jvm.html"><strong aria-hidden="true">4.</strong> java-memory-model-jmm-jvm</a></li><li class="chapter-item expanded "><a href="java-note.html"><strong aria-hidden="true">5.</strong> java-note</a></li><li class="chapter-item expanded "><a href="rust-note.html"><strong aria-hidden="true">6.</strong> rust-note</a></li><li class="chapter-item expanded "><a href="git-note.html"><strong aria-hidden="true">7.</strong> git note</a></li><li class="chapter-item expanded "><a href="linux-note.html"><strong aria-hidden="true">8.</strong> linux-note</a></li><li class="chapter-item expanded "><a href="cross-gfw.html"><strong aria-hidden="true">9.</strong> cross gfw</a></li><li class="chapter-item expanded "><a href="react-note.html"><strong aria-hidden="true">10.</strong> react-note</a></li><li class="chapter-item expanded "><a href="cs-note.html"><strong aria-hidden="true">11.</strong> cs note</a></li><li class="chapter-item expanded "><a href="distributed-system.html"><strong aria-hidden="true">12.</strong> distributed system</a></li><li class="chapter-item expanded "><a href="message-queue.html"><strong aria-hidden="true">13.</strong> message-queue</a></li><li class="chapter-item expanded "><a href="data-structure-and-algorithm.html"><strong aria-hidden="true">14.</strong> data structure and algorithm</a></li><li class="chapter-item expanded "><a href="effective-java-reading-note.html"><strong aria-hidden="true">15.</strong> effective java reading note</a></li><li class="chapter-item expanded "><a href="docker-note.html"><strong aria-hidden="true">16.</strong> docker note</a></li><li class="chapter-item expanded "><a href="how-to-test-java-app.html"><strong aria-hidden="true">17.</strong> how-to-test-java-app</a></li><li class="chapter-item expanded "><a href="maven-note.html"><strong aria-hidden="true">18.</strong> maven-note</a></li><li class="chapter-item expanded "><a href="mac.html"><strong aria-hidden="true">19.</strong> mac</a></li><li class="chapter-item expanded "><a href="autohotkey.html"><strong aria-hidden="true">20.</strong> AHK collection</a></li><li class="chapter-item expanded "><a href="class-conflict-check.html"><strong aria-hidden="true">21.</strong> class conflict check</a></li><li class="chapter-item expanded "><a href="cpp.html"><strong aria-hidden="true">22.</strong> cpp</a></li><li class="chapter-item expanded "><a href="create-blog-by-react.html"><strong aria-hidden="true">23.</strong> create blog by react</a></li><li class="chapter-item expanded "><a href="css-note.html"><strong aria-hidden="true">24.</strong> css-note</a></li><li class="chapter-item expanded "><a href="css-pre-processor.html"><strong aria-hidden="true">25.</strong> css pre processor</a></li><li class="chapter-item expanded "><a href="defect-about-java-programmer-from-programming-thinking.html"><strong aria-hidden="true">26.</strong> from programming thinking</a></li><li class="chapter-item expanded "><a href="design-pattern-note.html"><strong aria-hidden="true">27.</strong> design pattern note</a></li><li class="chapter-item expanded "><a href="dev-resources.html"><strong aria-hidden="true">28.</strong> dev resources</a></li><li class="chapter-item expanded "><a href="eclipse.html"><strong aria-hidden="true">29.</strong> eclipse</a></li><li class="chapter-item expanded "><a href="extjs-note.html"><strong aria-hidden="true">30.</strong> extjs-note</a></li><li class="chapter-item expanded "><a href="FreeMarker-note.html" class="active"><strong aria-hidden="true">31.</strong> FreeMarker-note</a></li><li class="chapter-item expanded "><a href="go-note.html"><strong aria-hidden="true">32.</strong> golang</a></li><li class="chapter-item expanded "><a href="hello-world.html"><strong aria-hidden="true">33.</strong> hexo</a></li><li class="chapter-item expanded "><a href="html-note.html"><strong aria-hidden="true">34.</strong> html-note</a></li><li class="chapter-item expanded "><a href="idea-note.html"><strong aria-hidden="true">35.</strong> idea-note</a></li><li class="chapter-item expanded "><a href="interview-system-design.html"><strong aria-hidden="true">36.</strong> interview-system-design</a></li><li class="chapter-item expanded "><a href="java-code-clean.html"><strong aria-hidden="true">37.</strong> java-code-clean</a></li><li class="chapter-item expanded "><a href="job-interview-cv.html"><strong aria-hidden="true">38.</strong> job-interview-cv</a></li><li class="chapter-item expanded "><a href="joke-collecting.html"><strong aria-hidden="true">39.</strong> joke-collecting</a></li><li class="chapter-item expanded "><a href="jquery-note.html"><strong aria-hidden="true">40.</strong> jquery-note</a></li><li class="chapter-item expanded "><a href="js-tutorial.html"><strong aria-hidden="true">41.</strong> js-tutorial</a></li><li class="chapter-item expanded "><a href="money.html"><strong aria-hidden="true">42.</strong> money</a></li><li class="chapter-item expanded "><a href="mongodb-note.html"><strong aria-hidden="true">43.</strong> mongodb-note</a></li><li class="chapter-item expanded "><a href="mvc-mvvm.html"><strong aria-hidden="true">44.</strong> mvc-mvvm</a></li><li class="chapter-item expanded "><a href="my-ioc.html"><strong aria-hidden="true">45.</strong> my-ioc</a></li><li class="chapter-item expanded "><a href="mybatis-note.html"><strong aria-hidden="true">46.</strong> mybatis-note</a></li><li class="chapter-item expanded "><a href="mysql-note.html"><strong aria-hidden="true">47.</strong> mysql-note</a></li><li class="chapter-item expanded "><a href="nodejs.html"><strong aria-hidden="true">48.</strong> nodejs</a></li><li class="chapter-item expanded "><a href="outline-about-cache.html"><strong aria-hidden="true">49.</strong> outline-about-cache</a></li><li class="chapter-item expanded "><a href="outline-about-db-design-note.html"><strong aria-hidden="true">50.</strong> outline-about-db-design-note</a></li><li class="chapter-item expanded "><a href="outline-about-http.html"><strong aria-hidden="true">51.</strong> outline-about-http</a></li><li class="chapter-item expanded "><a href="outline-about-rest-api.html"><strong aria-hidden="true">52.</strong> outline-about-rest-api</a></li><li class="chapter-item expanded "><a href="php-note.html"><strong aria-hidden="true">53.</strong> php-note</a></li><li class="chapter-item expanded "><a href="postgres-note.html"><strong aria-hidden="true">54.</strong> postgres-note</a></li><li class="chapter-item expanded "><a href="python-note.html"><strong aria-hidden="true">55.</strong> python-note</a></li><li class="chapter-item expanded "><a href="redis-login-limitation.html"><strong aria-hidden="true">56.</strong> redis-login-limitation</a></li><li class="chapter-item expanded "><a href="redis-note.html"><strong aria-hidden="true">57.</strong> redis-note</a></li><li class="chapter-item expanded "><a href="regex-js.html"><strong aria-hidden="true">58.</strong> regex-js</a></li><li class="chapter-item expanded "><a href="servlet.html"><strong aria-hidden="true">59.</strong> servlet</a></li><li class="chapter-item expanded "><a href="spring-note.html"><strong aria-hidden="true">60.</strong> spring-note</a></li><li class="chapter-item expanded "><a href="springboot-doc.html"><strong aria-hidden="true">61.</strong> springboot-doc</a></li><li class="chapter-item expanded "><a href="springmvc-note.html"><strong aria-hidden="true">62.</strong> springmvc-note</a></li><li class="chapter-item expanded "><a href="task-schedule-note.html"><strong aria-hidden="true">63.</strong> task-schedule-note</a></li><li class="chapter-item expanded "><a href="tcp-ip-note.html"><strong aria-hidden="true">64.</strong> tcp-ip-note</a></li><li class="chapter-item expanded "><a href="tomcat-jetty-nginx.html"><strong aria-hidden="true">65.</strong> tomcat-jetty-nginx</a></li><li class="chapter-item expanded "><a href="webpack-note.html"><strong aria-hidden="true">66.</strong> webpack-note</a></li><li class="chapter-item expanded "><a href="windows-sub-system-on-linux.html"><strong aria-hidden="true">67.</strong> windows-sub-system-on-linux</a></li></ol>
            </div>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle"></div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                
                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky bordered">
                    <div class="left-buttons">
                        <button id="sidebar-toggle" class="icon-button" type="button" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </button>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light (default)</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                        
                    </div>

                    <h1 class="menu-title">Xiaoyu Wiki</h1>

                    <div class="right-buttons">
                        <a href="print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>
                        
                    </div>
                </div>

                
                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" name="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>
                

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script type="text/javascript">
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <hr />
<p>title: FreeMarker Note
tags:</p>
<ul>
<li>template
date: 2017-08-25 21:46:25
categories: java web</li>
</ul>
<hr />
<div align="center">
references: https://freemarker.apache.org/docs/dgui_quickstart_template.html
</div>
<!--more-->
<!-- TOC -->
<ul>
<li><a href="#%E5%92%8Cjsp-velocity-thymeleaf%E5%AF%B9%E6%AF%94">和jsp-velocity-thymeleaf对比</a></li>
<li><a href="#%E5%92%8C-springboot-%E9%9B%86%E6%88%90">和 springboot 集成</a></li>
<li><a href="#quick-start">quick start</a></li>
<li><a href="#%E5%9F%BA%E6%9C%AC%E8%AF%AD%E6%B3%95">基本语法</a>
<ul>
<li><a href="#%E6%94%AF%E6%8C%81%E7%9A%84%E7%B1%BB%E5%9E%8B">支持的类型</a></li>
<li><a href="#if-%E6%9D%A1%E4%BB%B6%E6%8C%87%E4%BB%A4">if 条件指令</a></li>
<li><a href="#list-%E9%81%8D%E5%8E%86%E6%8C%87%E4%BB%A4">list 遍历指令</a></li>
<li><a href="#include-%E5%92%8C-import">include 和 import</a></li>
<li><a href="#%E5%AE%9A%E4%B9%89%E5%8F%98%E9%87%8F">定义变量</a></li>
<li><a href="#%E5%91%BD%E5%90%8D%E7%A9%BA%E9%97%B4">命名空间</a></li>
<li><a href="#%E8%81%94%E5%90%88%E4%BD%BF%E7%94%A8%E6%8C%87%E4%BB%A4">联合使用指令</a></li>
<li><a href="#%E5%86%85%E5%BB%BA%E5%87%BD%E6%95%B0">内建函数</a></li>
<li><a href="#%E6%96%B9%E6%B3%95%E5%92%8C%E5%87%BD%E6%95%B0">方法和函数</a></li>
<li><a href="#%E7%94%A8%E6%88%B7%E8%87%AA%E5%AE%9A%E4%B9%89%E6%8C%87%E4%BB%A4%E6%8E%A8%E8%8D%90%E4%BC%98%E5%85%88%E4%BD%BF%E7%94%A8">用户自定义指令(推荐优先使用)</a>
<ul>
<li><a href="#macro-nested-%E5%AE%8F%E6%8C%87%E4%BB%A4-%E5%B5%8C%E5%A5%97%E6%8C%87%E4%BB%A4">macro nested 宏指令 嵌套指令</a></li>
<li><a href="#%E5%AE%8F%E6%8C%87%E4%BB%A4%E4%B8%AD%E7%9A%84%E5%BE%AA%E7%8E%AF%E5%8F%98%E9%87%8F">宏指令中的循环变量</a></li>
</ul>
</li>
<li><a href="#%E8%A1%A8%E8%BE%BE%E5%BC%8F">表达式</a></li>
</ul>
</li>
<li><a href="#%E5%A4%84%E7%90%86%E4%B8%8D%E5%AD%98%E5%9C%A8%E7%9A%84%E5%8F%98%E9%87%8F">处理不存在的变量</a></li>
<li><a href="#%E5%B8%B8%E8%A7%81%E9%94%99%E8%AF%AF">常见错误</a>
<ul>
<li><a href="#%E6%8C%87%E4%BB%A4%E4%BD%93%E5%86%85%E9%83%A8%E5%8F%98%E9%87%8F%E6%97%A0%E9%9C%80">指令体内部变量无需${}</a></li>
<li><a href="#%E6%95%B0%E5%AD%97%E5%8D%83%E5%88%86%E4%BD%8D%E6%A0%BC%E5%BC%8F%E5%8C%96">数字千分位格式化</a></li>
</ul>
</li>
<li><a href="#%E7%A8%8B%E5%BA%8F%E5%BC%80%E5%8F%91">程序开发</a>
<ul>
<li><a href="#freemaker%E5%AF%B9%E8%B1%A1%E7%9A%84%E5%8C%85%E8%A3%85">freemaker对象的包装</a></li>
<li><a href="#configuration-%E9%85%8D%E7%BD%AE">Configuration 配置</a>
<ul>
<li><a href="#%E5%85%B1%E4%BA%AB%E5%8F%98%E9%87%8F">共享变量</a></li>
<li><a href="#%E4%B8%89%E5%B1%82%E9%85%8D%E7%BD%AE">三层配置</a>
<ul>
<li><a href="#configuration%E5%B1%82">Configuration层</a></li>
<li><a href="#template">Template</a></li>
<li><a href="#environment">Environment</a></li>
</ul>
</li>
<li><a href="#%E6%A8%A1%E6%9D%BF%E7%9A%84%E5%8A%A0%E8%BD%BD">模板的加载</a></li>
<li><a href="#%E9%94%99%E8%AF%AF%E6%8E%A7%E5%88%B6">错误控制</a></li>
</ul>
</li>
<li><a href="#%E9%80%9A%E8%BF%87java%E5%BC%80%E5%8F%91%E8%87%AA%E5%AE%9A%E4%B9%89%E6%96%B9%E6%B3%95">通过java开发自定义方法</a></li>
<li><a href="#%E9%80%9A%E8%BF%87java%E5%BC%80%E5%8F%91%E8%87%AA%E5%AE%9A%E4%B9%89%E6%8C%87%E4%BB%A4">通过java开发自定义指令</a></li>
</ul>
</li>
</ul>
<!-- /TOC -->
<h1><a class="header" href="#和jsp-velocity-thymeleaf对比" id="和jsp-velocity-thymeleaf对比">和jsp-velocity-thymeleaf对比</a></h1>
<p>https://blog.csdn.net/richard_vi/article/details/78849539</p>
<p>velocity 语法简单， freemarker 功能更强大</p>
<ul>
<li>FreeMarker可以对任意数量的类型执行运算和比较，包括任意精度类型，而不仅仅是整数。 </li>
<li>FreeMarker可以比较和显示（格式化）日期/时间值</li>
<li>FreeMarker可以基于各种各样的内置和自定义数字或者日期格式，来格式化数字区域或者日期地区时区等</li>
<li>1.5及以上版本的spring boot已经不支持velocity。</li>
</ul>
<h1><a class="header" href="#和-springboot-集成" id="和-springboot-集成">和 springboot 集成</a></h1>
<pre><code class="language-yml">
</code></pre>
<h1><a class="header" href="#quick-start" id="quick-start">quick start</a></h1>
<p>完成一个简单的demo, 需要准备2部分工作要做</p>
<pre><code class="language-html">数据模型

        (root)
        |
        +- user = &quot;Big Joe&quot;
        |
        +- latestProduct
            |
            +- url = &quot;products/greenmouse.html&quot;
            |
            +- name = &quot;green mouse&quot;
            |
            +- animals
            |   |
            |   +- (1st)
            |   |   |
            |   |   +- name = &quot;mouse&quot;
            |   |   |
            |   |   +- size = &quot;small&quot;
            |   |   |
            |   |   +- price = 50
            |   |
            |   +- (2nd)
            |   |   |
            |   |   +- name = &quot;elephant&quot;
            |   |   |
            |   |   +- size = &quot;large&quot;
            |   |   |
            |   |   +- price = 5000
            |   |
            |   +- (3rd)
            |       |
            |       +- name = &quot;python&quot;
            |       |
            |       +- size = &quot;medium&quot;
            |       |
            |       +- price = 4999
            |
            +- misc
                |
                +- fruits
                    |
                    +- (1st) = &quot;orange&quot;
                    |
                    +- (2nd) = &quot;banana&quot;

    模型数据通常来自于java对象, 树结构中的目录类比于嵌套对象, 称为`hashes`, 叶子节点称为`scalars`, 访问语法: latestProduct.url; 另外一种很重要的变量是 `sequences `, 它们像哈希表那样存储子变量，但是子变量没有名字，它们只是列表中的项, 语法: latestProduct.animals[0].name

*   模版

    &lt;html&gt;
        &lt;head&gt;
            &lt;title&gt;Welcome!&lt;/title&gt;
        &lt;/head&gt;
        &lt;body&gt;
            &lt;h1&gt;Welcome ${user}!&lt;/h1&gt;
            &lt;p&gt;Our latest product:
            &lt;a href=&quot;${latestProduct.url}&quot;&gt;${latestProduct.name}&lt;/a&gt;!
        &lt;/body&gt;
    &lt;/html&gt;
</code></pre>
<h1><a class="header" href="#基本语法" id="基本语法">基本语法</a></h1>
<ul>
<li>
<p><code>${...}</code> ： FreeMarker将会输出真实的值来替换大括号内的表达式，这样的表达式被称为 interpolation(插值)</p>
</li>
<li>
<p><code>FTL 标签</code> : (FreeMarker模板的语言标签)： FTL标签和HTML标签有一些相似之处，但是它们是FreeMarker的指令，是不会在输出中打印的。 这些标签的名字以 <code># </code>开头。(用户自定义的FTL标签则需要使用 @ 来代替 #)</p>
</li>
<li>
<p><code>注释</code>： 注释和HTML的注释也很相似， 但是它们使用 <code>&lt;#-- and --&gt; </code>来标识。 不像HTML注释那样，FTL注释不会出现在输出中(不出现在访问者的页面中)， 因为 FreeMarker会跳过它们。</p>
</li>
</ul>
<h2><a class="header" href="#支持的类型" id="支持的类型">支持的类型</a></h2>
<ul>
<li>标量(scalars)
<ul>
<li>字符串</li>
<li>数字</li>
<li>布尔值 true/false</li>
<li>日期/时间</li>
</ul>
</li>
<li>容器
<ul>
<li>哈希表: 每个子变量都可以通过一个唯一的名称来查找。 这个名称是不受限制的字符串。哈希表 并不确定其中子变量的顺序</li>
<li>序列: 每个子变量通过一个整数来标识,而且子变量是有顺序的, 子变量的类型也并不需要完全一致</li>
<li>集合: 集合是有限制的序列。不能获取集合的大小， 也不能通过索引取出集合中的子变量，但是它们仍然可以通过 list 指令来遍历。</li>
</ul>
</li>
</ul>
<h2><a class="header" href="#if-条件指令" id="if-条件指令">if 条件指令</a></h2>
<pre><code class="language-html">Welcome ${user}&lt;#if user == &quot;Big Joe&quot;&gt;, our beloved leader&lt;/#if&gt;!
</code></pre>
<p>若user == &quot;Big Joe&quot;, 则显示&quot;, our beloved leader&quot;</p>
<p>类似的, <code>不等于</code>的写法</p>
<pre><code class="language-html">&lt;#if animals.python.price != 0&gt;
  Pythons are not free today!
&lt;/#if&gt;
</code></pre>
<p>多重判断</p>
<pre><code class="language-html">&lt;#if animals.python.price &lt; animals.elephant.price&gt;
  Pythons are cheaper than elephants today.
&lt;#elseif animals.elephant.price &lt; animals.python.price&gt;
  Elephants are cheaper than pythons today.
&lt;#else&gt;
  Elephants and pythons cost the same today.
&lt;/#if&gt;
</code></pre>
<h2><a class="header" href="#list-遍历指令" id="list-遍历指令">list 遍历指令</a></h2>
<pre><code class="language-html">&lt;p&gt;We have these animals:
&lt;table border=1&gt;
  &lt;#list animals as animal&gt;
    &lt;tr&gt;&lt;td&gt;${animal.name}&lt;td&gt;${animal.price} Euros
  &lt;/#list&gt;
&lt;/table&gt;

&lt;#list [&quot;foo&quot;, &quot;bar&quot;, &quot;baz&quot;] as x&gt;
    ${x}
&lt;/#list&gt;
</code></pre>
<p>带分隔符的输出</p>
<pre><code class="language-html">Fruits: &lt;#list misc.fruits as fruit&gt;${fruit}&lt;#sep&gt;, &lt;/#list&gt;
</code></pre>
<p>也可以这么写: &lt;#sep&gt;, &lt;/#sep&gt;</p>
<p>这样最后一项后面就不会有分隔符了</p>
<p>进一步修改: 处理空值</p>
<pre><code class="language-html">Fruits: &lt;#list misc.fruits as fruit&gt;${fruit}&lt;#sep&gt;, &lt;#else&gt;None&lt;/#list&gt;
</code></pre>
<p>这样当没有值的时候, 会显示&quot;None&quot;;</p>
<p>另一种简写语法: <code>Fruits: ${fruits?join(&quot;, &quot;, &quot;None&quot;)}</code></p>
<p>list 和items合用, 处理空值:</p>
<pre><code class="language-html">&lt;#--items指令, 只有items里的元素才会循环--&gt;
&lt;#list nullTest&gt;
    &lt;ul&gt;
    &lt;#items as fruit&gt;
        &lt;li&gt;${fruit}
    &lt;/#items&gt;
    &lt;/ul&gt;
&lt;/#list&gt;
&lt;div&gt;上面没有空行&lt;/div&gt;

&lt;#--比较: 没有使用items的情况--&gt;
&lt;ul&gt;
    &lt;#list nullTest as fruit&gt;
        &lt;li&gt;${fruit}
    &lt;/#list&gt;
&lt;/ul&gt;
&lt;div&gt;有空行&lt;/div&gt;
</code></pre>
<h2><a class="header" href="#include-和-import" id="include-和-import">include 和 import</a></h2>
<pre><code class="language-html">&lt;body&gt;
  &lt;h1&gt;Test page&lt;/h1&gt;
  &lt;p&gt;Blah blah...
  &lt;#include &quot;/copyright_footer.html&quot;&gt;
&lt;/body&gt;
</code></pre>
<p>include只有开始标签, 没有结束标签, 因为没有标签嵌套内容, 结束标签可以省略</p>
<p>实际重用代码有更好的方式: 自定义指令(宏命令), 下文讨论</p>
<p>再看import, import也是用于变量生命导入声明</p>
<h2><a class="header" href="#定义变量" id="定义变量">定义变量</a></h2>
<ul>
<li>
<p>简单变量： 它能从模板中的任何位置来访问，或者从使用 include 指令引入的模板访问。可以使用 <code>assign 指令</code>来创建或替换这些变量。因为宏和方法只是变量，那么 <code>macro 指令 和 function 指令 也可以用来设置变量</code>，就像 assign 那样。</p>
</li>
<li>
<p>局部变量：它们只能被设置在 宏定义体内， 而且只在宏内可见。一个局部变量的生命周期只是宏的调用过程。可以使用<code> local指令</code> 在宏定义体内创建或替换局部变量。</p>
</li>
<li>
<p>循环变量：循环变量是由如 <code>list 指令</code>自动创建的，而且它们只在指令的开始和结束标记内有效。宏 的参数是局部变量而不是循环变量。</p>
</li>
<li>
<p>全局变量：这是一个高级话题了， 并且这种变量最好别用。即便它们属于不同的命名空间， 全局变量也被所有模板共享，因为它们是被 import进来的， 不同于 include 进来的。那么它们的可见度就像数据模型那样。 全局变量通过 <code>global指令</code>来定义。</p>
</li>
</ul>
<h2><a class="header" href="#命名空间" id="命名空间">命名空间</a></h2>
<p>使用 assign 和 macro 指令创建的变量的集合, 这样的变量集合就是命名空间; 如果想创建可以重复使用的宏，函数和其他变量的集合， 通常用术语来说就是引用 库, 为了避免变量名冲突, 引入命名空间;</p>
<p>首先建立一个库:</p>
<pre><code class="language-html">&lt;!-- 俩变量: copyright, mail; 保存在文件my_test.ftl --&gt;
&lt;#macro copyright date&gt;
  &lt;p&gt;Copyright (C) ${date} Julia Smith. All rights reserved.&lt;/p&gt;
&lt;/#macro&gt;

&lt;#assign mail = &quot;jsmith@acme.com&quot;&gt;

</code></pre>
<p>使用: 通过import命令引入(不要使用include命令, 因为这样会在主命名空间创建两个变量, 而import会引入新的命名空间)</p>
<pre><code class="language-html">&lt;#import &quot;/lib/my_test.ftl&quot; as my&gt; &lt;#-- the hash called &quot;my&quot; will be the &quot;gate&quot; --&gt;
&lt;@my.copyright date=&quot;1999-2002&quot;/&gt;
${my.mail}

&lt;!-- 在引入的命名空间中增加变量, assign命令
    结果:
    jsmith@acme.com
jsmith@other.com
 --&gt;
 &lt;#import &quot;/lib/my_test.ftl&quot; as my&gt;
${my.mail}
&lt;#assign mail=&quot;jsmith@other.com&quot; in my&gt;
${my.mail}
</code></pre>
<p>在模板中的变量优先级高于数据模型中的变量.</p>
<p>库的路径一般这样: /lib/yourcompany.com/your_library.ftl, 方便他人引用;</p>
<h2><a class="header" href="#联合使用指令" id="联合使用指令">联合使用指令</a></h2>
<p>指令可嵌套使用, 即使是在尖括号内部; 因为FreeMarker并不解析FTL标签以外的文本、插值和注释， 所以在HTML属性中使用FTL标签也不会有问题。</p>
<pre><code class="language-html">&lt;#list animals as animal&gt;
      &lt;div&lt;#if animal.protected&gt; class=&quot;protected&quot;&lt;/#if&gt;&gt;
        ${animal.name} for ${animal.price} Euros
      &lt;/div&gt;
&lt;/#list&gt;
</code></pre>
<h2><a class="header" href="#内建函数" id="内建函数">内建函数</a></h2>
<p>内建函数类似于子属性(scalars), 但是访问方法不是<code>.</code>, 而是<code>?</code>, 常用的列在这里</p>
<ul>
<li>user?html 给出 user 的HTML转义版本， 比如 &amp; 会由 <code>&amp;amp;</code> 来代替。</li>
<li>user?upper_case 给出 user 值的大写版本 (比如 &quot;JOHN DOE&quot; 来替代 &quot;John Doe&quot;)</li>
<li>animal.name?cap_first 给出 animal.name 的首字母大写版本(比如 &quot;Mouse&quot; 来替代 &quot;mouse&quot;)</li>
<li>user?length 给出 user 值中 字符的数量(对于 &quot;John Doe&quot; 来说就是8)</li>
<li>animals?size 给出 animals 序列中 项目 的个数</li>
<li>animal.protected?string(&quot;Y&quot;, &quot;N&quot;) 基于 animal.protected 的布尔值来返回字符串 &quot;Y&quot; 或 &quot;N&quot;。</li>
<li><code>animal?item_cycle('lightRow','darkRow')</code>, 根据当前animal计数的奇偶性, 返回字符串 &quot;odd&quot; 或 &quot;even&quot;, 在给不同行着色时使用</li>
<li><code>fruits?join(&quot;, &quot;)</code> 通过连接所有项，将列表转换为字符串， 在每个项之间插入参数分隔符<code>, </code></li>
<li><code>user?starts_with(&quot;J&quot;)</code> 根据 user 的首字母是否是 &quot;J&quot; 返回布尔值true或false</li>
<li>专门在&lt;#list&gt;指令体内使用的
<ul>
<li>animal?index 给出了在 animals 中基于0开始的 animal的索引值</li>
<li>animal?counter 也像 index， 但是给出的是基于1的索引值</li>
<li><code>animal?item_parity</code> 基于当前计数的奇偶性，给出字符串 &quot;odd&quot; 或 &quot;even&quot;。在给不同行着色时非常有用，比如在 <code>&lt;td class=&quot;${animal?item_parity}Row&quot;&gt;</code>中。功能同animal?item_cycle('lightRow','darkRow')</li>
</ul>
</li>
</ul>
<h2><a class="header" href="#方法和函数" id="方法和函数">方法和函数</a></h2>
<p>使用: </p>
<pre><code>The average of 3 and 5 is: ${avg(3, 5)}
The average of 6 and 10 and 20 is: ${avg(6, 10, 20)}
The average of the price of a python and an elephant is:
${avg(animals.python.price, animals.elephant.price)}
</code></pre>
<p>方法来自于数据模型中的定义, 函数来自于模版内的定义</p>
<h2><a class="header" href="#用户自定义指令推荐优先使用" id="用户自定义指令推荐优先使用">用户自定义指令(推荐优先使用)</a></h2>
<p>换句话说，就是FreeMarker的标签</p>
<p>假设现在有一个变量 box，它的值是用户自定义的指令， 用来打印一些特定的HTML信息，包含标题和一条信息。那么， box 变量就可以在模板中使用: </p>
<pre><code class="language-html">&lt;@box title=&quot;Attention!&quot;&gt;
  Too much copy-pasting may leads to
  maintenance headaches.
&lt;/@box&gt;
</code></pre>
<h3><a class="header" href="#macro-nested-宏指令-嵌套指令" id="macro-nested-宏指令-嵌套指令">macro nested 宏指令 嵌套指令</a></h3>
<pre><code class="language-html">&lt;#--user-customized-directive--&gt;
&lt;#--macro define--&gt;
&lt;#macro greet&gt;
    &lt;font size=&quot;+2&quot;&gt;Greet: hello&lt;/font&gt;
&lt;/#macro&gt;
&lt;#--macro 调用 --&gt;
&lt;@greet/&gt;
&lt;br&gt;
&lt;#--macro define 带参数, 这里名称相同会覆盖之前定义的同名宏--&gt;
&lt;#macro greet person&gt;
    &lt;font size=&quot;+2&quot;&gt;hello, ${person}&lt;/font&gt;
&lt;/#macro&gt;
&lt;@greet person=&quot;xiaoyutest&quot;/&gt;

&lt;!-- 定义多个参数, 带默认值, 调用时可以覆盖 --&gt;
&lt;#macro greet person color=&quot;black&quot;&gt;
  &lt;font size=&quot;+2&quot; color=&quot;${color}&quot;&gt;Hello ${person}!&lt;/font&gt;
&lt;/#macro&gt;

&lt;!-- 自定义指令嵌套内容, &lt;#nested&gt; 指令执行位于开始和结束标记指令之间的模板代码段。
    输出:
    &lt;table border=4 cellspacing=0 cellpadding=4&gt;&lt;tr&gt;&lt;td&gt;
    The bordered text
  &lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;
 --&gt;
&lt;#macro border&gt;
  &lt;table border=4 cellspacing=0 cellpadding=4&gt;&lt;tr&gt;&lt;td&gt;
    &lt;#nested&gt;
  &lt;/tr&gt;&lt;/td&gt;&lt;/table&gt;
&lt;/#macro&gt;
&lt;@border&gt;The bordered text&lt;/@border&gt;

&lt;!-- &lt;#nested&gt;可多次调用 
    输出:
    Anything.
  Anything.
  Anything.
--&gt;
&lt;#macro do_thrice&gt;
  &lt;#nested&gt;
  &lt;#nested&gt;
  &lt;#nested&gt;
&lt;/#macro&gt;
&lt;@do_thrice&gt;
  Anything.
&lt;/@do_thrice&gt;

&lt;!-- 如果 不使用nested指令, 嵌套内容将不会输出 --&gt;

</code></pre>
<h3><a class="header" href="#宏指令中的循环变量" id="宏指令中的循环变量">宏指令中的循环变量</a></h3>
<pre><code class="language-html">&lt;#macro do_thrice&gt;
    &lt;!-- 在这里指定变量的value, --&gt;
  &lt;#nested 1&gt;
  &lt;#nested 2&gt;
  &lt;#nested 3&gt;
&lt;/#macro&gt;
&lt;!-- x 相当于 &lt;#list foos as foo&gt;...&lt;/#list&gt; 中的 foo), 即变量的name 
    结果:
     1 Anything.
  2 Anything.
  3 Anything.
--&gt;
&lt;@do_thrice ; x&gt; &lt;#-- user-defined directive uses &quot;;&quot; instead of &quot;as&quot; --&gt;
  ${x} Anything.
&lt;/@do_thrice&gt;

&lt;!-- 宏指令中可以定义多个循环变量 
    结果:
     1. 0.5
    2. 1
    3. 1.5
    4. 2 Last!
--&gt;
&lt;#macro repeat count&gt;
    &lt;!-- 宏指令定义时, 定义自己的变量 --&gt;
  &lt;#list 1..count as x&gt;
    &lt;#nested x, x/2, x==count&gt;
  &lt;/#list&gt;
&lt;/#macro&gt;
&lt;!-- 宏命令调用时候, 定义调用时候使用的变量 --&gt;
&lt;@repeat count=4 ; c, halfc, last&gt;
  ${c}. ${halfc}&lt;#if last&gt; Last!&lt;/#if&gt;
&lt;/@repeat&gt;
</code></pre>
<h2><a class="header" href="#表达式" id="表达式">表达式</a></h2>
<p>表达式用于插值/指令参数</p>
<ul>
<li>直接指定值
<ul>
<li>字符串： &quot;Foo&quot; 或者 'Foo' 或者 &quot;It's &quot;quoted&quot;&quot; 或者 'It's &quot;quoted&quot;' 或者 r&quot;C:\raw\string&quot;</li>
<li>数字： 123.45</li>
<li>布尔值： true， false</li>
<li>序列： [&quot;foo&quot;, &quot;bar&quot;, 123.45]； 值域： 0..9, 0..&lt;10 (或 0..!10), 0..</li>
<li>哈希表： {&quot;name&quot;:&quot;green mouse&quot;, &quot;price&quot;:150}</li>
</ul>
</li>
<li>检索变量
<ul>
<li>顶层变量： user</li>
<li>从哈希表中检索数据： user.name， user[&quot;name&quot;]</li>
<li>从序列中检索数据： products[5]</li>
<li>特殊变量： .main</li>
</ul>
</li>
<li>字符串操作
<ul>
<li>插值(或连接)： &quot;Hello ${user}!&quot; (或 &quot;Hello &quot; + user + &quot;!&quot;)</li>
<li>获取一个字符： name[0]</li>
<li>字符串切分： 包含结尾： name[0..4]，不包含结尾： name[0..&lt;5]，基于长度(宽容处理)： name[0..*5]，去除开头： name[5..]</li>
</ul>
</li>
<li>序列操作
<ul>
<li>连接： users + [&quot;guest&quot;]</li>
<li>序列切分：包含结尾： products[20..29]， 不包含结尾： products[20..&lt;30]，基于长度(宽容处理)： products[20..*10]，去除开头：products[20..]</li>
</ul>
</li>
<li>哈希表操作
<ul>
<li>连接： passwords + { &quot;joe&quot;: &quot;secret42&quot; }</li>
</ul>
</li>
<li>算术运算： (x * 1.5 + 10) / 2 - y % 100</li>
<li>比较运算： x == y， x != y， x &lt; y， x &gt; y， x &gt;= y， x &lt;= y， x lt y， x lte y， x gt y， x gte y， 等等。。。。。。</li>
<li>逻辑操作： !registered &amp;&amp; (firstVisit || fromEurope)</li>
<li>内建函数： name?upper_case, path?ensure_starts_with('/')</li>
<li>方法调用： repeat(&quot;What&quot;, 3)</li>
<li>处理不存在的值：
<ul>
<li>默认值： name!&quot;unknown&quot; 或者 (user.name)!&quot;unknown&quot; 或者 name! 或者 (user.name)!</li>
<li>检测不存在的值： name?? 或者 (user.name)??</li>
</ul>
</li>
<li>赋值操作： =, +=, -=, *=, /=, %=, ++, --</li>
</ul>
<h1><a class="header" href="#处理不存在的变量" id="处理不存在的变量">处理不存在的变量</a></h1>
<p>这里可分为2种情况, 变量不存在or变量值为null. freemaker一视同仁</p>
<p>可以为变量设置默认值:</p>
<pre><code class="language-html">&lt;h1&gt;Welcome ${user!&quot;visitor&quot;}!&lt;/h1&gt;
</code></pre>
<p><code>${user!&quot;visitor&quot;}</code>表示如果user变量值丢失, 用visitor代替; </p>
<p>还可以和if指令结合使用</p>
<pre><code class="language-html">&lt;#if user??&gt;&lt;h1&gt;Welcome ${user}!&lt;/h1&gt;&lt;/#if&gt;
</code></pre>
<p>如果碰到了多级访问的变量, 如<code>animals.python.price!0</code>, 如果 animals 或 python 不存在， 那么模板处理过程将会以&quot;未定义的变量&quot;错误而停止, 当且仅当 animals.python 永远存在， 而仅仅最后一个子变量 price 可能不存在时用默认值0代替最终值, 其他情况均报错程序终止;合适的写法是: <code>(animals.python.price)!0</code>, animals 或 python 不存在时， 表达式的结果是 0; </p>
<p>对于<code>??</code> 多级访问变量的处理类似</p>
<h1><a class="header" href="#常见错误" id="常见错误">常见错误</a></h1>
<h2><a class="header" href="#指令体内部变量无需" id="指令体内部变量无需">指令体内部变量无需${}</a></h2>
<p>用户所犯的一个常见错误是将插值放在了不需要/不应该使用的地方。 插值 仅 在 文本 区 中有效。(比如， <code>&lt;h1&gt;Hello ${name}!&lt;/h1&gt;</code>) 还有在字符串值中 (比如， <code>&lt;#include &quot;/footer/${company}.html&quot;&gt;</code>)。 典型的 错误 使用是 &lt;#if ${big}&gt;...&lt;/#if&gt;， 这会导致语法错误。简单写为 &lt;#if big&gt;...&lt;/#if&gt;即可。 而且， &lt;#if &quot;${big}&quot;&gt;...&lt;/#if&gt; 也是 错误的， 因为它将参数值转换为字符串，但是 if 指令只接受布尔值， 那么这将导致运行时错误。</p>
<h2><a class="header" href="#数字千分位格式化" id="数字千分位格式化">数字千分位格式化</a></h2>
<p>因为很多地区使用分组(千分位分隔符)，那么 &quot;someUrl?id=&quot; + id 就可能会是 &quot;someUrl?id=1 234&quot;。 要预防这种事情的发生，请使用 <code>?c </code>(对计算机来说)内建函数，那么在 <code>&quot;someUrl?id=&quot; + id?c </code>或 <code>&quot;someUrl?id=${id?c}&quot;</code>中， 就会得到如 &quot;someUrl?id=1234&quot; 这样的输出， 而不管本地化和格式的设置是什么。</p>
<h1><a class="header" href="#程序开发" id="程序开发">程序开发</a></h1>
<h2><a class="header" href="#freemaker对象的包装" id="freemaker对象的包装">freemaker对象的包装</a></h2>
<p>数据模型中，可以使用基本的Java集合类作为变量，因为这些变量会在内部被替换为适当的 TemplateModel 类型。这种功能特性被称作是 对象包装; 对象包装功能可以透明地把 任何 类型的对象转换为实现了 TemplateModel 接口类型的实例;</p>
<p>编写一个简单的模版, 只有插值</p>
<p>test.ftl</p>
<pre><code class="language-html">hello ${user.name}, your job is ${user.job}, your school is ${user.school}

And your addr is ${user.addr}
</code></pre>
<p>启动类:
CodeGenerator.java</p>
<pre><code class="language-java">public class CodeGenerator {

    public static void main(String[] args) throws Exception {
        String classpathWithSeparator = new CodeGenerator().getClasspath();
        Configuration cfg = new Configuration(Configuration.VERSION_2_3_27);
        try {
            cfg.setDirectoryForTemplateLoading(new File(classpathWithSeparator + &quot;codetpl&quot;));
            
        } catch (IOException e) {
            throw new TplDirNotExistException(&quot;模版目录不存在&quot;, e);
        }
        cfg.setDefaultEncoding(&quot;UTF-8&quot;);
        cfg.setTemplateExceptionHandler(TemplateExceptionHandler.RETHROW_HANDLER);
        
        Template tpl = null;
        try {
            tpl = cfg.getTemplate(&quot;test.ftl&quot;);
        } catch (IOException e) {
            throw new TplFileNotExistException(&quot;模版文件不存在&quot;, e);
        }
        OutputStreamWriter writer = new OutputStreamWriter(System.out);
        
        User user = new User();
        user.setAddr(&quot;上海&quot;);
        user.setJob(&quot;程序员&quot;);
        user.setName(&quot;谢大脚&quot;);
        user.setSchool(&quot;象牙山小学&quot;);
        HashMap&lt;String, Object&gt; map = new HashMap&lt;String, Object&gt;();
        map.put(&quot;user&quot;, user);
        tpl.process(map, writer);
    }
    
    public String getClasspath() {
        return this.getClass()
                .getClassLoader()
                .getResource(&quot;&quot;)
                .getPath().toString();
    }
    
}
</code></pre>
<p>此外还有一些自定义exception, bean, 这里省略了, 结果如下:</p>
<pre><code>20:12:53.854 [main] DEBUG freemarker.cache - Couldn't find template in cache for &quot;test.ftl&quot;(&quot;zh_CN&quot;, UTF-8, parsed); will try to load it.
20:12:53.854 [main] DEBUG freemarker.cache - TemplateLoader.findTemplateSource(&quot;test_zh_CN.ftl&quot;): Not found
20:12:53.854 [main] DEBUG freemarker.cache - TemplateLoader.findTemplateSource(&quot;test_zh.ftl&quot;): Not found
20:12:53.854 [main] DEBUG freemarker.cache - TemplateLoader.findTemplateSource(&quot;test.ftl&quot;): Found
20:12:53.854 [main] DEBUG freemarker.cache - Loading template for &quot;test.ftl&quot;(&quot;zh_CN&quot;, UTF-8, parsed) from &quot;D:\\repo\\eclipse\\ssm-demo-yml\\target\\classes\\codetpl\\test.ftl&quot;
hello 谢大脚, your job is 程序员, your school is 象牙山小学

And your addr is 上海
</code></pre>
<p>但是在开发自定义方法or命令时, 需要使用到freemaker中的包装对象, 模板中可用的变量都是实现了 freemarker.template.TemplateModel 接口的Java对象 </p>
<p>顶层接口<code>freemarker.template.TemplateModel</code> 的子接口对应每种基本变量类型(<code>TemplateHashModel</code> 对应哈希表，<code> TemplateSequenceModel</code> 对应序列， <code>TemplateNumberModel</code> 对应数字, <code>TemplateScalarModel</code>对应字符串等等)。</p>
<p>比如，想为模板使用 java.sql.ResultSet 变量作为一个序列，那么就需要编写一个<code>TemplateSequenceModel</code>的实现类，这个类要能够读取 java.sql.ResultSet 中的内容。即TemplateModel 的实现类 中维护一个ResultSet私有变量; 请注意一个类可以实现多个 TemplateModel 接口；这就是为什么FTL变量可以有多种类型;</p>
<p>freemaker已经实现了常用的变量类型: SimpleScalar(String), SimpleHash (Map)等等</p>
<h2><a class="header" href="#configuration-配置" id="configuration-配置">Configuration 配置</a></h2>
<p>配置(configuration)就是 freemarker.template.Configuration 对象， 它存储了常用(全局，应用程序级)的设置，定义了想要在所有模板中可用的变量(称为共享变量)。 而且，它会处理 Template 实例的新建和缓存</p>
<h3><a class="header" href="#共享变量" id="共享变量">共享变量</a></h3>
<p>Shared variables (共享变量)是为所有模板定义的变量。可以使用 setSharedVariable 方法向配置中添加共享变量：</p>
<pre><code class="language-java">Configuration cfg = new Configuration(Configuration.VERSION_2_3_22);
...
cfg.setSharedVariable(&quot;warp&quot;, new WarpDirective());
cfg.setSharedVariable(&quot;company&quot;, &quot;Foo Inc.&quot;);
</code></pre>
<p>在所有使用这个配置的模板中，名为 wrap 的用户自定义指令和一个名为 company 的字符串将会在数据模型的根root上可见， 那就不用在根哈希表上一次又一次的添加它们。在传递给 Template.process 的 根root对象里的变量将会隐藏同名的共享变量</p>
<p>出于向后兼容的特性，共享变量的集合初始化时 (就是对于新的 Configuration 实例来说)不能为空。 它包含下列用户自定义指令(用户自定义指令使用时需要用 @ 来代替#)：</p>
<p><img src="./FreeMarker-note/1.png" alt="" /></p>
<h3><a class="header" href="#三层配置" id="三层配置">三层配置</a></h3>
<p>Settings(配置设置) 是影响FreeMarker行为的已被命名的值。配置设置有很多， 例如：locale，number_format， default_encoding， template_exception_handler。</p>
<p>配置信息可以被想象成3层(Configuration， Template，Environment), 加载顺序由后到前为(优先级由高到低):</p>
<p><img src="./FreeMarker-note/2.png" alt="" /></p>
<p>具体如何配置呢?</p>
<h4><a class="header" href="#configuration层" id="configuration层">Configuration层</a></h4>
<pre><code class="language-java">Configuration myCfg = new Configuration(Configuration.VERSION_2_3_23);
myCfg.setTemplateExceptionHandler(TemplateExceptionHandler.RETHROW_HANDLER);
myCfg.setDefaultEncoding(&quot;UTF-8&quot;);

</code></pre>
<p>spring中配置:</p>
<pre><code class="language-xml">&lt;bean id=&quot;freemarkerConfig&quot;
    class=&quot;org.springframework.web.servlet.view.freemarker.FreeMarkerConfigurer&quot;&gt;
  &lt;property name=&quot;freemarkerSettings&quot;&gt;
    &lt;props&gt;
      &lt;prop key=&quot;incompatible_improvements&quot;&gt;2.3.23&lt;/prop&gt;
      &lt;prop key=&quot;template_exception_handler&quot;&gt;rethrow&lt;/prop&gt;
      &lt;prop key=&quot;default_encoding&quot;&gt;UTF-8&lt;/prop&gt;
    &lt;/props&gt;
  &lt;/property&gt;
&lt;/bean&gt;
</code></pre>
<h4><a class="header" href="#template" id="template">Template</a></h4>
<h4><a class="header" href="#environment" id="environment">Environment</a></h4>
<p>使用Java API：使用 Environment 对象的setter方法。当然想要在模板执行之前来做，然后当调用 myTemplate.process(...) 时会遇到问题， 因为在内部创建 Environment 对象后立即就执行模板了， 导致没有机会来进行设置。这个问题的解决可以用下面两个步骤进行：</p>
<pre><code class="language-java">Environment env = myTemplate.createProcessingEnvironment(root, out);
env.setLocale(java.util.Locale.ITALY);
env.setNumberFormat(&quot;0.####&quot;);
env.process();  // process the template
</code></pre>
<p>还有一种方法, 但是不推荐:</p>
<pre><code class="language-html">&lt;#setting locale=&quot;it_IT&quot;&gt;
&lt;#setting number_format=&quot;0.####&quot;&gt;
</code></pre>
<h3><a class="header" href="#模板的加载" id="模板的加载">模板的加载</a></h3>
<p>configuration提供了三个方法, 代表三种方式:</p>
<pre><code class="language-java">public void setClassForTemplateLoading(Class clazz, String pathPrefix);// 使用: cfg.setClassForTemplateLoading(FreemarkerUtil.class, &quot;/template&quot;);    cfg.getTemplate(&quot;Base.ftl&quot;);

public void setDirectoryForTemplateLoading(File dir) throws IOException;

public void setServletContextForTemplateLoading(Object servletContext, String path);// 基于web project, 参数path表示WebRoot下的目录路径, 如: &quot;/ftl&quot;) 就是 /WebRoot/ftl目录
</code></pre>
<p>从多个位置加载模版: 不使用内建加载器 ,使用一个特殊的加载器---ClassTemplateLoader</p>
<pre><code class="language-java">FileTemplateLoader ftl1 = new FileTemplateLoader(new File(&quot;/tmp/templates&quot;));
FileTemplateLoader ftl2 = new FileTemplateLoader(new File(&quot;/usr/data/templates&quot;));
ClassTemplateLoader ctl = new ClassTemplateLoader(getClass(), &quot;&quot;);
TemplateLoader[] loaders = new TemplateLoader[] { ftl1, ftl2, ctl };
MultiTemplateLoader mtl = new MultiTemplateLoader(loaders);

cfg.setTemplateLoader(mtl);
</code></pre>
<p>现在，FreeMarker将会尝试从 /tmp/templates 目录加载模板，如果在这个目录下没有发现请求的模板，它就会继续尝试从 /usr/data/templates 目录下加载，如果还是没有发现请求的模板， 那么它就会使用类加载器来加载模板。</p>
<p>编写自己的模版加载器要注意那些呢?</p>
<p>如果内建的类加载器都不适合使用，那么就需要来编写自己的类加载器了， 这个类需要实现 freemarker.cache.TemplateLoader 接口， 然后将它传递给 Configuration 对象的 setTemplateLoader(TemplateLoader loader)方法。</p>
<p>如果模板需要通过URL访问其他模板，那么就不需要实现 TemplateLoader 接口了，可以选择子接口 freemarker.cache.URLTemplateLoader 来替代， 只需实现 URL getURL(String templateName) 方法即可</p>
<p>模版缓存:</p>
<p>FreeMarker 是会缓存模板的(假设使用 Configuration 对象的方法来创建 Template 对象)。这就是说当调用 getTemplate方法时，FreeMarker不但返回了 Template 对象，而且还会将它存储在缓存中， 当下一次再以相同(或相等)路径调用 getTemplate 方法时， 那么它只返回缓存的 Template 实例， 而不会再次加载和解析模板文件了。</p>
<p>那么开发阶段怎么禁用这个特性? --- 有一个 Configuration 级别的设置被称作&quot;更新延迟&quot;, 这个时间就是从上次对某个模板检查更新后，FreeMarker再次检查模板所要间隔的时间。 其默认值是5秒; 设为0即可;</p>
<h3><a class="header" href="#错误控制" id="错误控制">错误控制</a></h3>
<p>关于 FreeMarker 发生的异常，可以分为3类:</p>
<ul>
<li>当配置 FreeMarker 时发生异常：典型地情况，就是在应用程序初始化时， 仅仅配置了一次 FreeMarker。在这个过程中，异常就会发生</li>
<li>当加载和解析模板时发生异常：调用了 Configuration.getTemplate(...) 方法， FreeMarker就要把模板文件加载到内存中然后来解析它 (除非模板已经在 Configuration 对象中被 缓存 了)。 在这期间, 异常又可以被细分为两类
<ul>
<li>因模板文件没有找到而发生的 IOException 异常</li>
<li>根据FTL语言的规则，模板文件发生语法错误时会导致 freemarker.core.ParseException异常。当获得 Template对象 (Configuration.getTemplate(...))时， 这种错误就会发生，而不是当执行 (Template.process(...))模板的时候。 这种异常是 IOException 的一个子类。</li>
</ul>
</li>
<li>当执行(处理)模板时发生的异常，也就是当调用了 Template.process(...) 方法时会发生的两种异常：
<ul>
<li>当试图写入输出对象时发生错误而导致的 IOException 异常</li>
<li>执行模板时发生的其它问题而导致的 freemarker.template.TemplatException 异常</li>
</ul>
</li>
</ul>
<p>根据不同的TemplateException来自定义处理方式:</p>
<pre><code class="language-java">// 自定义异常处理类
class MyTemplateExceptionHandler implements TemplateExceptionHandler {
    public void handleTemplateException(TemplateException te, Environment env, java.io.Writer out)
            throws TemplateException {
        try {
            out.write(&quot;[ERROR: &quot; + te.getMessage() + &quot;]&quot;);
        } catch (IOException e) {
            throw new TemplateException(&quot;Failed to print error message. Cause: &quot; + e, env);
        }
    }
}

// 设置进configuration
cfg.setTemplateExceptionHandler(new MyTemplateExceptionHandler());
</code></pre>
<p>这是如果模版文件是这样 <code>a${&quot;xiaoyu&quot; + badVar}b</code>, 而 badVar不存在, 输出的内容是这样:</p>
<pre><code class="language-html">a[ERROR: Expression badVar is undefined on line 1, column 4 in test.ftl.]b
</code></pre>
<p>整个插值会被跳过.</p>
<p>同样, 如果错误发生在指令调用中的参数计算时, 整个指令会被跳过, 如: 模版<code>a&lt;#if badVar&gt;Foo&lt;/#if&gt;b</code>, 输出是</p>
<pre><code class="language-html">a[ERROR: Expression badVar is undefined on line 1, column 7 in test.ftl.]b
</code></pre>
<p>如果错误发生在已经开始执行的指令之后，那么指令调用将不会被跳过, 如: </p>
<pre><code class="language-html">a
&lt;#if true&gt;
  Foo
  ${badVar}
  Bar
&lt;/#if&gt;
c
</code></pre>
<p>输出是这样的: </p>
<pre><code class="language-html">a
  Foo
  [ERROR: Expression badVar is undefined on line 4, column 5 in test.ftl.]
  Bar
c
</code></pre>
<p>FreeMarker 本身带有这些预先编写的错误控制器:</p>
<ul>
<li>
<p><code>TemplateExceptionHandler.DEBUG_HANDLER</code>： 打印堆栈跟踪信息(包括FTL错误信息和FTL堆栈跟踪信息)和重新抛出的异常。 这是默认的异常控制器(也就是说，在所有新的 Configuration 对象中，它是初始化好的)。</p>
</li>
<li>
<p><code>TemplateExceptionHandler.HTML_DEBUG_HANDLER</code>： 和 DEBUG_HANDLER 相同，但是它可以格式化堆栈跟踪信息， 那么就可以在Web浏览器中来阅读错误信息。 在制作HTML页面时，建议使用它而不是 DEBUG_HANDLER。</p>
</li>
<li>
<p><code>TemplateExceptionHandler.IGNORE_HANDLER</code>： 忽略所有异常, FreeMarker 仍然会写日志。 它对处理异常没有任何作用，也不会重新抛出异常。</p>
</li>
<li>
<p><code>TemplateExceptionHandler.RETHROW_HANDLER</code>： 简单重新抛出所有异常而不会做其它的事情。 这个控制器对Web应用程序来说非常好， 因为它在生成的页面发生错误的情况下，给了你很多对Web应用程序的控制权 (因为FreeMarker不向输出中打印任何关于该错误的信息)。 要获得更多在Web应用程序中处理错误的信息</p>
</li>
</ul>
<h2><a class="header" href="#通过java开发自定义方法" id="通过java开发自定义方法">通过java开发自定义方法</a></h2>
<p>开发这样一个方法: indexOf(arg1, arg2), 返回字符串arg1在arg2中的位置索引</p>
<pre><code class="language-java">public class IndexOfMethod implements TemplateMethodModelEx {

    @Override
    public Object exec(List args) throws TemplateModelException {
        if (args.size() != 2) {
            throw new TemplateModelException(&quot;参数个数不对.&quot;);
        }
        else {
            Object obj1 = args.get(0);
            if (obj1 instanceof SimpleScalar) {
                SimpleScalar sca1 = (SimpleScalar) obj1;
                
                Object obj2 = args.get(1);
                if (obj2 instanceof SimpleScalar) {
                    SimpleScalar sca2 = (SimpleScalar) obj2;
                    return sca1.toString().indexOf(sca2.toString());
                }
                else {
                    throw new TemplateModelException(&quot;参数[2]类型不对.&quot;);
                }
            } 
            else {
                throw new TemplateModelException(&quot;参数[1]类型不对.&quot;);
            }
        }
    }

}

// 当然需要将开发的方法传到数据模型中, 如果需要访问FTL运行时环境(读/写变量，获取本地化信息等)，则可以使用 Environment.getCurrentEnvironment() 来获取。
// 启动类基础上增加:
map.put(&quot;indexOf&quot;, new IndexOfMethod());
</code></pre>
<p>在test.ftl中使用</p>
<pre><code class="language-html">&lt;#assign x = &quot;something&quot;&gt;
${indexOf(&quot;m&quot;, x)}
${indexOf(&quot;foo&quot;, x)}
</code></pre>
<h2><a class="header" href="#通过java开发自定义指令" id="通过java开发自定义指令">通过java开发自定义指令</a></h2>
<pre><code class="language-java">
/**
 * 转大写指令
 *
 * @version 0.1
 * @author xy
 * @date 2018年2月2日 下午10:03:59
 */
public class UpperDirective implements TemplateDirectiveModel {
    
    private Logger logger = LoggerFactory.getLogger(UpperDirective.class);

    @Override
    public void execute(Environment env, Map params, TemplateModel[] loopVars, TemplateDirectiveBody body)
            throws TemplateException, IOException {
        logger.debug(&quot;xy---------UpperDirective: execute()&quot;);
        
        if (!params.isEmpty()) {
            throw new TemplateModelException(&quot;不允许参数&quot;);
        }
        if (loopVars.length != 0) {
            throw new TemplateModelException(&quot;不允许循环变量&quot;);
        }
        if (body != null) {
            body.render(new Writer() {// handle the body content
                
                Writer out = env.getOut();// 通过Environment获取在启动类中设置的writter
                
                @Override
                public void write(char[] cbuf, int off, int len) throws IOException {
                    // transfer
                    char[] rst = new char[len];
                    for(int i=0; i&lt;len; i++) {
                        rst[i] = Character.toUpperCase(cbuf[i + off]);
                    }
                    
                    out.write(rst);
                }
                
                @Override
                public void flush() throws IOException {
                    out.flush();
                }
                
                @Override
                public void close() throws IOException {
                    out.close();
                }
            });
        } 
        else {
            throw new RuntimeException(&quot;缺失嵌套内容&quot;);
        }
        
        
    }

}

// 启动类基础上添加:
map.put(&quot;upper&quot;, new UpperDirective());


</code></pre>
<p>这里是直接将指令添加进了数据模型中, 但更好的做法是将常用的指令作为 共享变量 放到 Configuration 中</p>
<p>当然也可以使用 内建函数new 将指令放到一个FTL库(宏的集合，就像在模板中， 使用 include 或 import )中：</p>
<pre><code class="language-html">&lt;#-- Maybe you have directives that you have implemented in FTL --&gt;
&lt;#macro something&gt;
  ...
&lt;/#macro&gt;

&lt;#-- Now you can't use &lt;#macro upper&gt;, but instead you can: --&gt;
&lt;#assign upper = &quot;com.example.UpperDirective&quot;?new()&gt;

</code></pre>
<p>模版中使用:</p>
<pre><code class="language-html">foo
&lt;@upper&gt;
  bar
  &lt;#-- All kind of FTL is allowed here --&gt;
  &lt;#list [&quot;red&quot;, &quot;green&quot;, &quot;blue&quot;] as color&gt;
    ${color}
  &lt;/#list&gt;
  baaz
&lt;/@upper&gt;
wombat
</code></pre>
<p>结果:</p>
<pre><code>foo
  BAR
    RED
    GREEN
    BLUE
  BAAZ
wombat

</code></pre>
<p>下面来个复杂点的例子: 创建一个指令，这个指令可以一次又一次地执行其中的嵌套内容， 这个次数由指定的数字来确定(就像 list 指令)， 可以使用<hr>将输出的重复内容分开</p>
<p>模版内容:</p>
<pre><code class="language-html">&lt;#assign x = 1&gt;

&lt;@repeat count=4&gt;
  Test ${x}
  &lt;#assign x++&gt;
&lt;/@repeat&gt;

&lt;@repeat count=3 hr=true&gt;
  Test
&lt;/@repeat&gt;

&lt;@repeat count=3; cnt&gt;
  ${cnt}. Test
&lt;/@repeat&gt;
</code></pre>
<p>预期结果:</p>
<pre><code>  Test 1
  Test 2
  Test 3
  Test 4

  Test
&lt;hr&gt;  Test
&lt;hr&gt;  Test

  1. Test
  2. Test
  3. Test
</code></pre>
<p>开发指令:</p>
<pre><code class="language-java">/**
 * repeat directive
 *
 * @version 0.1
 * @author xy
 * @date 2018年2月3日 下午1:49:20
 */
public class RepeatDirective implements TemplateDirectiveModel {
    
    private final Logger logger = LoggerFactory.getLogger(RepeatDirective.class);
    private static final String PARAM_NAME_COUNT = &quot;count&quot;;
    private static final String PARAM_NAME_HR = &quot;hr&quot;;

    @SuppressWarnings(&quot;rawtypes&quot;)
    @Override
    public void execute(Environment env, Map params, TemplateModel[] loopVars, TemplateDirectiveBody body)
            throws TemplateException, IOException {
        logger.debug(&quot;xy-----------RepeatDirective: execute()&quot;);
        
        int count = 0;
        boolean hr = false;
        
        boolean countSetup = false; // count 参数是否设置
        
        if (loopVars.length &gt; 1) {
            throw new TemplateModelException(&quot;循环变量个数只能为[1]&quot;);
        }
        if (params.isEmpty()) {
            throw new TemplateModelException(&quot;必须有参数&quot;);
        }
        else {
            Iterator iter = params.entrySet().iterator();
            while(iter.hasNext()) {
                Entry ent = (Entry) iter.next();
                Object keyObj = ent.getKey();
                String key = (String) keyObj;
                Object valueObj = ent.getValue();
                TemplateModel value = (TemplateModel) valueObj;
                
                if (PARAM_NAME_COUNT.equals(key)) {
                    if (value instanceof TemplateNumberModel) {
                        count = ((TemplateNumberModel) value).getAsNumber().intValue();
                        countSetup = true;
                        
                        if (count &lt; 0) {
                            throw new TemplateModelException(&quot;参数[&quot;+key+&quot;]不可以是负数&quot;);
                        }
                    }
                    else {
                        throw new TemplateModelException(&quot;参数[&quot;+key+&quot;]类型不是number.&quot;);
                    }
                }
                else if (PARAM_NAME_HR.equals(key)) {
                    if (value instanceof TemplateBooleanModel) {
                        hr = ((TemplateBooleanModel) value).getAsBoolean();
                    }
                }
                else {
                    throw new TemplateModelException(&quot;不支持的参数:[&quot;+key+&quot;]&quot;);
                }
                
            }
            if (!countSetup) {
                throw new TemplateModelException(&quot;参数[&quot;+PARAM_NAME_COUNT+&quot;]未设置&quot;);
            }
            
            if (body != null) {
                Writer out = env.getOut();
                for(int i=0; i&lt;count; i++) {
                    if (loopVars.length == 1) {
                        loopVars[0] = new SimpleNumber(i + 1);
                    }
                    if (hr &amp;&amp; i != 0) {
                        out.write(&quot;&lt;hr&gt;&quot;);
                    }
                    
                    body.render(out);
                }
            } 
            else {
                throw new RuntimeException(&quot;body 缺失.&quot;);
            }
        }
    }
}

</code></pre>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                        
                            <a rel="prev" href="extjs-note.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>
                        

                        
                            <a rel="next" href="go-note.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>
                        

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                
                    <a rel="prev" href="extjs-note.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>
                

                
                    <a rel="next" href="go-note.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
                
            </nav>

        </div>

        

        

        
        
        
        <script type="text/javascript">
            window.playpen_copyable = true;
        </script>
        

        

        
        <script src="elasticlunr.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="mark.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="searcher.js" type="text/javascript" charset="utf-8"></script>
        

        <script src="clipboard.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="highlight.js" type="text/javascript" charset="utf-8"></script>
        <script src="book.js" type="text/javascript" charset="utf-8"></script>

        <!-- Custom JS scripts -->
        

        

    </body>
</html>
