---
title: 架构总结
tags: [arch]
categories: computer science
---

<!--more-->

<!-- TOC -->

- [设计原则](#设计原则)
    - [高可用](#高可用)
    - [高并发](#高并发)
- [负载均衡](#负载均衡)
- [隔离](#隔离)
    - [hystrix](#hystrix)
    - [servlet3](#servlet3)
- [限流](#限流)
    - [算法](#算法)
        - [令牌桶算法](#令牌桶算法)
        - [漏桶算法](#漏桶算法)

<!-- /TOC -->

# 设计原则

## 高可用

- 服务降级

- 隔离

    - 线程隔离 （thread  pool）

    - 进程隔离（系统拆分）

    - 动静态资源隔离（cdn存放静态资源）

- 限流

- 故障时切流量

    - 在 nginx 中切换故障的应用层

    - dns 切换机房入口

- 可回滚

    事物回滚， 代码版本回滚， 部署版本回滚， 数据库回滚


## 高并发

- 无状态

    方便水平拓展

- 拆分

    - 系统解耦， 拆分成多个子系统， 可分别独立水平拓展

    - 读写分离

- 消息队列

    解耦（一对多消费）， 削峰， 异步

    对于一对多消费， 可以惊醒镜像复制

- 缓存

    - 浏览器缓存

        响应头 Expires， Cache-control

    - 静态资源进行 cdn 缓存

    - 接入层缓存， 如搭建 nginx 作为接入层

    - 应用层缓存

        在 应用所在 server 上部署 redis， 多机间使用 redis 主从同步

    - 分布式缓存

        分片规则：一致性哈希


- 服务化

    单点远程服务调用 -> 服务集群化 + nginx 负载均衡 

    调用方更多后， 考虑使用服务自动注册/发现

    考虑服务隔离，防止级联故障

    考虑服务限流， 连接超时时间/重试， 服务路由， 降级


# 负载均衡

client -》 dns

client -》 lvs/f5 （软硬件lb，这里是四层负载均衡，一般有专门运维来管理）-》 nginx （七层负载均衡，开发可以关注这里）-》 tomcat （upstream server）

# 隔离

## hystrix 

## servlet3 





# 限流

## 算法

区别： 令牌桶输出速率可以变化 , 令牌以恒定速率颁发,可以以任意速度消耗；漏桶输出速率恒定 ,溢出的请求则拒绝或丢弃

### 令牌桶算法

Token Bucket

原理： 系统会以一个恒定的速度往桶里放入令牌，而如果请求需要被处理，则需要先从桶里获取一个令牌，当桶里没有令牌可取时，则拒绝服务。

> 大小固定的令牌桶可自行以恒定的速率源源不断地产生令牌。如果令牌不被消耗，或者被消耗的速度小于产生的速度，令牌就会不断地增多，直到把桶填满。后面再产生的令牌就会从桶中溢出。最后桶中可以保存的最大令牌数永远不会超过桶的大小。
> 传送到令牌桶的数据包需要消耗令牌。不同大小的数据包，消耗的令牌数量不一样。
> 令牌桶这种控制机制基于令牌桶中是否存在令牌来指示什么时候可以发送流量。令牌桶中的每一个令牌都代表一个字节。如果令牌桶中存在令牌，则允许发送流量；而如果令牌桶中不存在令牌，则不允许发送流量

Guava 的 RateLimiter 使用了 这个算法

作用过程：

假如用户配置的平均发送速率为r，则每隔1/r秒一个令牌被加入到桶中；
假设桶最多可以存发b个令牌。如果令牌到达时令牌桶已经满了，那么这个令牌会被丢弃；
当一个n个字节的数据包到达时，就从令牌桶中删除n个令牌，并且数据包被发送到网络；
如果令牌桶中少于n个令牌，那么不会删除令牌，并且认为这个数据包在流量限制之外；
算法允许最长b个字节的突发，但从长期运行结果看，数据包的速率被限制成常量r

如何实现：

一种解法是，开启一个定时任务，由定时任务持续生成令牌。这样的问题在于会极大的消耗系统资源，如，某接口需要分别对每个用户做访问频率限制，假设系统中存在6W用户，则至多需要开启6W个定时任务来维持每个桶中的令牌数，这样的开销是巨大的。

另一种解法则是延迟计算，如上resync函数。该函数会在每次获取令牌之前调用，其实现思路为，若当前时间晚于nextFreeTicketMicros，则计算该段时间内可以生成多少令牌，将生成的令牌加入令牌桶中并更新数据。这样一来，只需要在获取令牌时计算一次即可

### 漏桶算法

Leaky Bucket

就是一个队列， 强制一个常量的输出速率而不管输入数据流的突发性。当输入空闲时，该算法不执行任何动作；


